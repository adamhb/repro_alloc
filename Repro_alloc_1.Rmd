---
title: "Repro_alloc_1"
author: "R.Ward"
date: "2/25/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The goal of this preliminary analysis is to look at the allocation to reproduction among BCI's most common species(in units of mass per unit reproductive basal area) between PFTs.     
We're interested in:   

repro_allocation / allocation_leaves  
seed_allocation / repro_allocation  

Our PFTs are: drought tolerant and intolerant (dt/di) and early and late successional(es/ls).  

Adam HB has filtered BCI species list for those with greater than 50 reproductive individuals, giving us a list of 26 species.   

Joe Wright has extracted the summed reproductive output for these species from two sites, with 62 and 60 traps respectively.

```{r}
library(tidyverse)
library(readr)
library(skimr)
```

1.  Importing sp. list  

```{r}
#this file contains the spp list and pfts for the 26 spp identified with more than 50 repro individuals
species_list_26 <- read_csv("species_list_for_repro_alloc_26_mostabund_sp.csv", col_types = cols(
  sp = col_character(),
  Latin = col_character(),
  dmax = col_double(),
  wsg = col_double(),
  e_vs_l = col_factor(),
  dpft = col_factor(),
  repro_abund_2010 = col_double(),
  pft = col_factor()
))
head(species_list_26)

#should e_vs_l, dpft, pft be factors? or characters? 

```

2. Importing 50-ha plot data  
- This file sums 62 traps in the 50 ha plot for which masses were recorded from 25 June 2013 through 29 January 2019
```{r}
mass_data_50haplot <- read_csv("Hanbury_Brown_50ha_20190221.csv", col_types = cols(sp = col_character(), 
                                                                                   type = col_factor(), 
                                                                                   mass = col_double(),
                                                                                   Freq = col_double())
                                                                                      )
skim(mass_data_50haplot)
head(mass_data_50haplot)

```

3. Importing 60 trap data  
- This file sums 60 traps from a second site (Poacher's Peninsula??) from 25 Nov 1985 through 19 Feb 2018:
```{r}
mass_data_60traps<- read_csv("Hanbury_Brown_60traps_20190221.csv", col_types = cols(
                                                                                      sp = col_character(), 
                                                                                      type = col_factor(), 
                                                                                      mass = col_double(),
                                                                                      Freq = col_double()
                                                                                      ))
skim(mass_data_60traps)
```


Note: I think that the second set of data (60 traps) is for Poacher's Peninsula.    
I'm not sure if we have repro basal area outside of the 50ha plot, so I'm going to work with the 50-ha plot 62 trap data first.   

4. BCI trait data  
- First, extracting reproductive trait data from BCITRAITS 
- Units are in g

```{r}
bci_repro_traits <- read_csv("BCITRAITS_20101220 (1).csv") %>%
                    mutate(sp = tolower(`SP$`)) %>%
                    select(sp, FRUIT_DRY, N_SEEDFULL, SEED_DRY, DSPR_DRY)

#view(BCITRAITS_20101220_1_)

head(bci_repro_traits) 
```

5. Extracting repro. basal area per sp (50 ha plot) data
 - In seed production dataset most recent repro basal area estimates are from 2012. (see repro_basal_area.rmd)
 - This data set doesn't have repro basal area esimates for all sp in our sp list
 - I'm going to use repro basal area values sent to me by Adam HB, which has values for all of our sp.
 - Need to double check with ABH - year and units (probably 2010, m2)
 
6. Extracting basal area per sp (50 ha plot) (to later extrapolate leaf litter to the 50-ha plot)

 
```{r}
# basal area is from 2010
# repro basal area is from ????
# units are in m2 - CHECK THIS
basal_area <- read_csv("basal_area_2010.csv") %>%
              select(sp, ba)
head(basal_area)
skim(basal_area)

ba_rba <- repro_basal_area %>%
          left_join(basal_area, by = "sp")
head(ba_rba)

sp_list_with_ba_rba <- species_list_26 %>%
                        left_join(ba_rba, by = "sp")
skim(sp_list_with_ba_rba)
head(sp_list_with_ba_rba)


```


7. Joining availible trait data (g), basal area data (m2), and sp list data into 1 dataframe for 50 ha plot (62 traps, .5m2)

```{r}
mass_data_50haplot
Data_50_ha <- mass_data_50haplot %>%
                    left_join(species_list_26, by = "sp") %>%
                    left_join(bci_repro_traits, by = "sp") %>%
                    left_join(ba_rba, by = "sp")

#this df includes all categories (flower, leaf, im fruit, mat fruit), bci repro traits, repro ba, total ba, pfts 

skim(Data_50_ha)
head(Data_50_ha)

```

8. Scaling reproductive output and leaf output for each species
  - dividing to find a yearly average (our mass data sums 25 June 2013 through 29 January 2019 = 67 months; mass/67  * 12 = avg per yr)
  - dividing yearly mass by 62 to find a trap average
  - scaling repro output (per trap, or 0.5m2) to repro basal area on BCI's 50 ha plot 
  

```{r}
#filtering for repro structures from repro data, summing for total repro mass per sp, and per reproductive individuals of that sp
repro_total_df <- Data_50_ha %>%
                    filter(type != "leaf") %>%
                    group_by(sp)%>%
                    mutate(repro_mass_total = sum(mass)) %>%
                    mutate(repro_mass_per_yr = repro_mass_total * 12 / 67) %>%
                    mutate(repro_mass_per_yr_trap = repro_mass_per_yr/62) %>%
                    mutate(repro_mass_per_yr_indv = repro_mass_per_yr / repro_abund_2010) %>%
                    mutate(repro_output_50_ha = (2 * repro_mass_per_yr_trap * r_ba)) %>%
                    select(sp, type, repro_mass_total, repro_mass_per_yr_indv, repro_mass_per_yr, repro_mass_per_yr_trap, repro_output_50_ha)

#for "repro_output_50_ha", traps are in g/0.5m2, r_ba units are in m2 of 50-ha plot, reult is in g/yr output for repro basal area of 50-ha plot

repro_total_df

leaf_total_df <- Data_50_ha %>%
                 filter(type == "leaf") %>%
                 group_by(sp) %>%
                 mutate(leaf_mass_per_yr = mass * 12 / 67) %>%
                 mutate(leaf_mass_per_yr_trap = leaf_mass_per_yr/ 62) %>%
                 mutate(leaf_output_50_ha = (2 * leaf_mass_per_yr_trap * ba)) %>%
                 select(sp, type, leaf_mass_per_yr, leaf_mass_per_yr_trap, leaf_output_50_ha)


leaf_total_df
#joining the reproductive df and leaf df with full df for 50 ha plot 

Data_50_ha_1 <- Data_50_ha %>%
                      left_join(repro_total_df, by = c("sp", "type")) %>%
                      left_join(leaf_total_df, by = c("sp", "type"))
                      
                      
#testing
Data_50_ha_1


repro_output_per_sp <- Data_50_ha_1 %>%
                       filter(type == "mature fruit") %>%
                       select(sp, repro_output_50_ha)
  
leaf_output_per_sp <- Data_50_ha_1 %>%
                      filter(type == "leaf") %>%
                      select(sp, leaf_output_50_ha)

frac_repro_output_df <- leaf_output_per_sp %>%
                        left_join(repro_output_per_sp, by = "sp") %>%
                        mutate(frac_repro_output = repro_output_50_ha / leaf_output_50_ha) %>%
                        select(sp, frac_repro_output)

Data_50_ha_2 <- Data_50_ha_1 %>%
                left_join(frac_repro_output_df, by = "sp")
#testing

Data_50_ha_2

```

9. Cacluating expected values for:  
- number of fruit (extrapolated from mature fruit mass using BCI trait values)
- number of seeds
- mass of seeds
- fraction of total reproductive output that is seed

NOTE: there are no SE values for reproductive traits in BCITRAITS data

```{r}
#filtering for mature fruit, calculating expected values for fruit mass, seed #, seed mass, seed_mass/repro_mass
repro_seeds_df <- Data_50_ha_2 %>%
                    filter(type == "mature fruit") %>%
                    mutate(n_fruit_total = mass / FRUIT_DRY) %>%
                    mutate(n_seeds_total = n_fruit_total * N_SEEDFULL) %>%
                    mutate(seed_mass_total = n_seeds_total * SEED_DRY) %>%
                    mutate(seeds_fraction_of_repro = seed_mass_total / repro_mass_total) %>%
                    select(sp, type, n_fruit_total, n_seeds_total, seed_mass_total, seeds_fraction_of_repro)

repro_seeds_df

#joining this with main df, Data_50_ha_1

Repro_data_50_ha <- Data_50_ha_2 %>%
                    left_join(repro_seeds_df, by = c("sp", "type"))
#this includes all of the above calulated values for each category for each species
Repro_data_50_ha
view(Repro_data_50_ha)


```


10. Summarizing by pfts: 

```{r}

#Looking at: repro / leaf 

head(frac_repro_output_df)

#graphing pfts
frac_repro_output_df %>%
        left_join(species_list_26, by = "sp") %>%
        group_by(pft) %>%
        ggplot(aes(pft, frac_repro_output)) + geom_boxplot()
  
#summarizing by pft
frac_repro_output_df %>%
        left_join(species_list_26, by = "sp") %>%
        group_by(pft) %>%
        summarize(per_pft_frac_repro_output = mean(frac_repro_output, na.rm = TRUE),
            se = sd(frac_repro_output, na.rm = T)/length(frac_repro_output))

#graphing e vs l
frac_repro_output_df %>%
        left_join(species_list_26, by = "sp") %>%
        group_by(e_vs_l) %>%
        ggplot(aes(e_vs_l, frac_repro_output)) + geom_boxplot()

#graphing dt vs di
frac_repro_output_df %>%
        left_join(species_list_26, by = "sp") %>%
        group_by(dpft) %>%
        ggplot(aes(dpft, frac_repro_output)) + geom_boxplot()


#Looking at seeds / repro 
repro_seeds_df %>%
    select(sp, seeds_fraction_of_repro) %>%
    left_join(species_list_26, by = "sp") %>%
    select(sp, pft, e_vs_l, dpft, seeds_fraction_of_repro)

#graphing pft
repro_seeds_df %>%
        left_join(species_list_26, by = "sp") %>%
        group_by(pft) %>%
        ggplot(aes(pft, seeds_fraction_of_repro)) + geom_boxplot()

#summarizing by pft
repro_seeds_df %>%
        left_join(species_list_26, by = "sp") %>%
        group_by(pft) %>%
        summarize(per_pft_seed_frac_repro = mean(seeds_fraction_of_repro, na.rm = T), 
                  se = sd(seeds_fraction_of_repro, na.rm = T)/length(seeds_fraction_of_repro))
   
#graphing e_vs_l
repro_seeds_df %>%
        left_join(species_list_26, by = "sp") %>%
        group_by(e_vs_l) %>%
        ggplot(aes(e_vs_l, seeds_fraction_of_repro)) + geom_boxplot()

#graphing dt vs di
repro_seeds_df %>%
        left_join(species_list_26, by = "sp") %>%
        group_by(dpft) %>%
        ggplot(aes(dpft, seeds_fraction_of_repro)) + geom_boxplot()

                
```




Next steps: 

1. Identify missing values & associated types
2. Diaspers?
3. Estimates of fruit/seed losses

  




  
  


